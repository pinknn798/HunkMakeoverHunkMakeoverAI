<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 形象分析 & 专属建议生成器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --secondary: #8b5cf6;
        --bg: #f8fafc;
        --text-main: #1e293b;
        --text-sub: #64748b;
        --white: #ffffff;
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.5);
        --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        --radius: 16px;
      }

      body {
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        color: var(--text-main);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* Navbar */
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 40px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        z-index: 1000;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }
      .logo {
        font-weight: 800;
        font-size: 24px;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .nav-links a {
        color: var(--text-sub);
        text-decoration: none;
        margin-left: 24px;
        font-size: 15px;
        font-weight: 600;
        transition: color 0.2s;
      }
      .nav-links a:hover,
      .nav-links a.active {
        color: var(--primary);
      }

      /* Hero Section */
      .hero {
        padding: 140px 20px 80px;
        text-align: center;
        max-width: 1000px;
        margin: 0 auto;
      }
      .hero h1 {
        font-size: clamp(36px, 6vw, 64px);
        font-weight: 800;
        background: linear-gradient(to right, #1e293b, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 24px;
        line-height: 1.1;
        letter-spacing: -0.02em;
      }
      .hero p {
        font-size: 20px;
        color: var(--text-sub);
        margin-bottom: 48px;
        max-width: 640px;
        margin-left: auto;
        margin-right: auto;
      }

      /* Upload Area */
      .upload-container {
        background: var(--white);
        border-radius: 32px;
        padding: 48px;
        box-shadow: 0 20px 60px -10px rgba(59, 130, 246, 0.15);
        max-width: 640px;
        margin: 0 auto;
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.8);
      }
      
      .input-group {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        justify-content: center;
      }
      .input-field {
        background: #f1f5f9;
        border: 2px solid transparent;
        padding: 16px 20px;
        border-radius: 16px;
        font-size: 16px;
        width: 140px;
        outline: none;
        transition: all 0.2s;
        font-weight: 500;
        color: var(--text-main);
        text-align: center;
      }
      .input-field:focus {
        background: #fff;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }
      .input-field::placeholder {
        color: #94a3b8;
      }

      .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 20px;
        padding: 40px 20px;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        background: #f8fafc;
      }
      .upload-zone:hover,
      .upload-zone.dragover {
        border-color: var(--primary);
        background: #eff6ff;
        transform: scale(1.01);
      }
      .btn-upload {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 16px 40px;
        font-size: 18px;
        font-weight: 700;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
      }
      .btn-upload:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 12px 28px rgba(59, 130, 246, 0.4);
      }
      .upload-hint {
        margin-top: 16px;
        font-size: 14px;
        color: var(--text-sub);
        font-weight: 500;
      }

      /* Steps */
      .steps-section {
        padding: 80px 20px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .steps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 32px;
      }
      .step-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        padding: 32px;
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
      }
      .step-card:hover {
        transform: translateY(-5px);
      }
      .step-num {
        background: linear-gradient(135deg, #e0e7ff, #dbeafe);
        color: var(--primary);
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 20px;
        margin-bottom: 20px;
      }
      .step-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 12px;
        color: var(--text-main);
      }
      .step-desc {
        font-size: 15px;
        color: var(--text-sub);
        line-height: 1.6;
      }

      /* Result Section */
      .result-section {
        padding: 60px 20px;
        max-width: 1000px;
        margin: 0 auto;
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
      }
      .result-section.visible {
        opacity: 1;
        transform: translateY(0);
      }
      .result-grid {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 48px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border-radius: 32px;
        padding: 40px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.8);
      }
      @media (max-width: 860px) {
        .result-grid {
          grid-template-columns: 1fr;
        }
      }
      .user-photo {
        width: 100%;
        border-radius: 24px;
        overflow: hidden;
        position: relative;
        aspect-ratio: 3/4;
        background: #f1f5f9;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
      }
      .user-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .analysis-content h2 {
        margin: 0 0 24px 0;
        font-size: 32px;
        color: var(--text-main);
        letter-spacing: -0.02em;
      }
      .face-tag {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 8px 20px;
        border-radius: 30px;
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 32px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      .suggestion-box {
        background: #f8fafc;
        border-radius: 20px;
        padding: 28px;
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
      }
      .suggestion-box h3 {
        margin: 0 0 16px 0;
        font-size: 20px;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .suggestion-list {
        margin: 0;
        padding-left: 20px;
        color: var(--text-sub);
      }
      .suggestion-list li {
        margin-bottom: 12px;
        font-size: 15px;
      }
      .suggestion-list strong {
        color: var(--text-main);
        font-weight: 600;
      }

      /* Calibration UI */
      .calibrate-panel {
        margin-top: 24px;
        padding: 20px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        font-size: 14px;
      }
      .calibrate-controls {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      .calibrate-controls select {
        padding: 8px 16px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        outline: none;
        flex: 1;
      }
      .btn-small {
        background: #334155;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .calibrate-hint {
        color: #94a3b8;
        font-size: 13px;
      }

      /* Examples Section */
      .examples {
        padding: 100px 20px;
        background: white;
        text-align: center;
      }
      .section-title {
        font-size: 36px;
        font-weight: 800;
        margin-bottom: 60px;
        background: linear-gradient(to right, #1e293b, #475569);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .examples-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 24px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .example-card {
        aspect-ratio: 3/4;
        background: #f1f5f9;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
      }
      .example-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
      }
      .example-card:hover img {
        transform: scale(1.05);
      }
      .example-label {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        color: white;
        font-weight: 600;
        text-align: left;
      }

      /* CTA Footer */
      .cta-footer {
        padding: 100px 20px;
        text-align: center;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        position: relative;
        overflow: hidden;
      }
      .cta-footer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
      }
      .cta-footer h2 {
        font-size: 40px;
        margin-bottom: 20px;
        font-weight: 800;
      }
      .cta-footer p {
        color: #94a3b8;
        font-size: 18px;
        margin-bottom: 48px;
      }
      .btn-gold {
        background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        color: white;
        border: none;
        padding: 20px 48px;
        font-size: 20px;
        font-weight: 700;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 30px rgba(217, 119, 6, 0.3);
        border: 2px solid rgba(255,255,255,0.2);
      }
      .btn-gold:hover {
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 12px 40px rgba(217, 119, 6, 0.5);
      }
      
      .qr-code-container {
        margin: 40px auto;
        background: white;
        padding: 12px;
        border-radius: 16px;
        width: 160px;
        height: 160px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
      
      .privacy-note {
        margin-top: 32px;
        font-size: 14px;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255,255,255,0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        backdrop-filter: blur(8px);
      }
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
          style="color: var(--primary)"
        >
          <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" />
          <path d="M12 6v6l4 2" />
        </svg>
        HunkAI
      </div>
      <div class="nav-links">
        <a href="#" class="active">AI 形象分析</a>
        <a href="#examples">真实案例</a>
      </div>
    </nav>

    <header class="hero">
      <h1>AI 形象分析 & 专属建议生成器</h1>
      <p>上传照片，30秒获取你的脸型 + 发型穿搭专业建议，打造明星级形象</p>

      <div class="upload-container">
        <div class="input-group">
            <input type="number" class="input-field" placeholder="身高 (cm)" id="heightInput">
            <input type="number" class="input-field" placeholder="体重 (kg)" id="weightInput">
        </div>

        <div class="upload-zone" id="dropZone">
          <input id="fileInput" type="file" accept="image/*" style="display: none" />
          <div style="margin-bottom: 20px">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#3b82f6"
              stroke-width="1.5"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
          </div>
          <button class="btn-upload" onclick="document.getElementById('fileInput').click()">
            Upload 正脸照片
          </button>
          <div class="upload-hint">支持 JPEG/PNG · 清晰正面照最佳 · 本地处理不上传</div>
        </div>
        
        <div id="loadingState" class="loading-overlay hidden">
            <div style="margin-bottom: 16px">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" style="animation: spin 1s linear infinite">
                    <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>
                </svg>
            </div>
            <div style="font-weight: 700; color: var(--text-main); font-size: 18px; margin-bottom: 4px;">AI 正在分析面部特征...</div>
            <div style="font-size: 14px; color: var(--text-sub);">首次加载模型可能需要几秒钟</div>
        </div>
      </div>
    </header>

    <section class="steps-section">
      <div class="steps-grid">
        <div class="step-card">
          <div class="step-num">1</div>
          <div class="step-title">上传照片</div>
          <div class="step-desc">选择一张光线充足、五官清晰的正面照片，并输入基本身材数据。</div>
        </div>
        <div class="step-card">
          <div class="step-num">2</div>
          <div class="step-title">AI 智能分析</div>
          <div class="step-desc">
            基于 face-api.js 深度学习模型，精准识别 68 个面部关键点与轮廓特征。
          </div>
        </div>
        <div class="step-card">
          <div class="step-num">3</div>
          <div class="step-title">获取专属方案</div>
          <div class="step-desc">
            生成匹配你脸型的发型与穿搭建议，支持添加专家微信获取定制改造服务。
          </div>
        </div>
      </div>
    </section>

    <section id="resultSection" class="result-section hidden">
      <div class="result-grid">
        <div class="left-col">
          <div class="user-photo" id="previewBox">
            <!-- Image will be inserted here -->
          </div>
          <div class="calibrate-panel">
             <div class="calibrate-controls">
                <select id="calibrateShape"></select>
                <button class="btn-small" id="calibrateButton">校准</button>
             </div>
             <div class="calibrate-hint" id="calibrateHint"></div>
          </div>
        </div>
        <div class="analysis-content">
          <div id="faceTags"></div>
          <h2 id="adviceTitle">专属形象建议</h2>
          <p id="analysisText" style="color: var(--text-sub); margin-bottom: 32px; font-size: 15px;"></p>
          
          <div class="suggestion-box">
            <h3>
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                发型推荐
            </h3>
            <ul class="suggestion-list" id="hairList"></ul>
          </div>
          
          <div class="suggestion-box">
            <h3>
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M16 12l-4-4-4 4"/><path d="M12 16V8"/></svg>
                穿搭方向
            </h3>
            <ul class="suggestion-list" id="styleList"></ul>
          </div>
        </div>
      </div>
    </section>

    <section id="examples" class="examples">
      <div class="section-title">看看这些真实学员逆袭前后</div>
      <div class="examples-grid">
        <div class="example-card">
            <img src="https://placehold.co/400x500/e2e8f0/1e293b?text=Case+1" alt="Case 1">
            <div class="example-label">程序员小王 / 改造后</div>
        </div>
        <div class="example-card">
            <img src="https://placehold.co/400x500/e2e8f0/1e293b?text=Case+2" alt="Case 2">
            <div class="example-label">销售经理李 / 改造后</div>
        </div>
        <div class="example-card">
            <img src="https://placehold.co/400x500/e2e8f0/1e293b?text=Case+3" alt="Case 3">
            <div class="example-label">大学生张同学 / 改造后</div>
        </div>
        <div class="example-card">
            <img src="https://placehold.co/400x500/e2e8f0/1e293b?text=Case+4" alt="Case 4">
            <div class="example-label">自由职业者陈 / 改造后</div>
        </div>
      </div>
    </section>

    <footer class="cta-footer">
      <h2>准备好改变了吗？</h2>
      <p>获取 1 对 1 私人定制改造方案，从头到脚的蜕变</p>
      
      <div class="qr-code-container">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=HunkAI_Consult" alt="添加微信" style="width:100%;height:100%">
      </div>
      
      <button class="btn-gold">添加微信获取定制方案</button>
      
      <div class="privacy-note">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </svg>
        照片仅在本地浏览器处理，不会上传至任何服务器
      </div>
    </footer>

    <script src="./vendor/face-api.min.js"></script>
    <script>
      const fileInput = document.getElementById("fileInput");
      const dropZone = document.getElementById("dropZone");
      const previewBox = document.getElementById("previewBox");
      const resultSection = document.getElementById("resultSection");
      const loadingState = document.getElementById("loadingState");
      
      const faceTags = document.getElementById("faceTags");
      const analysisText = document.getElementById("analysisText");
      const hairList = document.getElementById("hairList");
      const styleList = document.getElementById("styleList");
      const adviceTitle = document.getElementById("adviceTitle");
      const calibrateShape = document.getElementById("calibrateShape");
      const calibrateButton = document.getElementById("calibrateButton");
      const calibrateHint = document.getElementById("calibrateHint");
      const heightInput = document.getElementById("heightInput");
      const weightInput = document.getElementById("weightInput");

      const suggestions = {
        鹅蛋脸: {
          hair: [
            "几乎所有发型都适合，优先<strong>中分/侧分</strong>与<strong>层次短发</strong>",
            "<strong>后梳油头</strong>、<strong>纹理烫</strong>、<strong>飞机头</strong>或<strong>寸头</strong>都很稳",
            "避免过度蓬松或过度扁平的极端造型",
          ],
          style: [
            "领型基本通吃，<strong>修身衬衫</strong>+<strong>西装外套</strong>更显精致",
            "用<strong>上浅下深</strong>配色更显清爽",
            "简约韩系<strong>oversize</strong>也很好看",
          ],
        },
        圆脸: {
          hair: [
            "重点<strong>增加高度</strong>拉长脸部，<strong>蓬巴杜</strong>或<strong>油头向上抓</strong>",
            "<strong>侧分/中分蓬松刘海</strong>，两侧短、头顶高",
            "避免<strong>齐刘海</strong>与过短贴头",
          ],
          style: [
            "<strong>V领/小V领</strong>拉长脖子，优先<strong>竖条纹</strong>",
            "<strong>上深下浅</strong>或修身夹克+直筒裤更利落",
            "避免大圆领与横条纹",
          ],
        },
        方脸: {
          hair: [
            "目标<strong>柔化棱角</strong>，<strong>后梳油头</strong>+侧削渐层",
            "<strong>纹理烫</strong>/<strong>微卷侧分</strong>，顶部蓬松更显精神",
            "避免平刘海与直发死板",
          ],
          style: [
            "用<strong>V领</strong>或小开领柔化下巴线条",
            "<strong>修身西装/夹克</strong>+<strong>深色上衣</strong>更显轮廓",
            "避免横条纹与过宽领",
          ],
        },
        长脸: {
          hair: [
            "视觉上<strong>缩短脸长</strong>，短发+<strong>刘海遮额头</strong>",
            "<strong>偏分/侧分</strong>带弧度，避免过长直发",
            "避免露额头的后梳",
          ],
          style: [
            "<strong>圆领/高领</strong>缩短脖子比例",
            "横向条纹或宽松上衣更平衡",
            "短款外套+高腰裤更协调",
          ],
        },
        心形脸: {
          hair: [
            "重点<strong>平衡下巴</strong>，稍长发+<strong>弧度刘海</strong>",
            "<strong>Quiff</strong>/<strong>蓬松顶部</strong>或微卷侧分",
            "避免尖锐短发",
          ],
          style: [
            "<strong>圆领</strong>或小V领扩大下巴存在感",
            "肩部有结构的外套更显平衡",
            "避免尖领与极短上衣",
          ],
        },
        菱形脸: {
          hair: [
            "用<strong>烫发</strong>/<strong>层次不齐短发</strong>缓和锋利感",
            "<strong>顶部蓬松</strong>+轻胡子更立体",
            "避免顺直贴头",
          ],
          style: [
            "<strong>修身夹克</strong>+有肩线外套增强气场",
            "横向细节平衡肩宽",
            "避免窄肩上衣",
          ],
        },
        三角形脸: {
          hair: [
            "增加<strong>上部宽度</strong>，稍长发+顶部厚实",
            "<strong>蓬松刘海</strong>或上宽下窄卷发",
            "避免头顶过扁",
          ],
          style: [
            "<strong>垫肩/结构外套</strong>增强上半身",
            "<strong>V领</strong>拉长比例更利落",
            "避免紧身上衣与突兀领型",
          ],
        },
      };

      const displayNames = {
        鹅蛋脸: "鹅蛋脸/椭圆脸",
        方脸: "方脸/国字脸",
        心形脸: "心形脸/瓜子脸",
        三角形脸: "三角脸",
      };

      const faceShapes = Object.keys(suggestions);
      let modelsPromise;
      let lastMetrics;

      const shapeTargets = {
        圆脸: { faceRatio: 1.18, jawAngle: 155, jawToCheek: 0.98, foreheadToJaw: 1.0 },
        方脸: { faceRatio: 1.32, jawAngle: 145, jawToCheek: 0.98, foreheadToJaw: 1.0 },
        长脸: { faceRatio: 1.6, jawAngle: 135, jawToCheek: 0.88, foreheadToJaw: 1.0 },
        心形脸: { faceRatio: 1.35, jawAngle: 130, jawToCheek: 0.9, foreheadToJaw: 1.18 },
        鹅蛋脸: { faceRatio: 1.38, jawAngle: 135, jawToCheek: 0.9, foreheadToJaw: 1.05 },
        菱形脸: { faceRatio: 1.36, jawAngle: 132, jawToCheek: 0.86, foreheadToJaw: 1.08 },
        三角形脸: { faceRatio: 1.2, jawAngle: 125, jawToCheek: 1.12, foreheadToJaw: 0.95 },
      };
      
      const storageKey = "face-shape-calibration";
      const storedTargets = localStorage.getItem(storageKey);
      if (storedTargets) {
        const parsed = JSON.parse(storedTargets);
        faceShapes.forEach((shape) => {
          if (parsed[shape]) {
            shapeTargets[shape] = parsed[shape];
          }
        });
      }

      const updateCalibrateHint = () => {
        const shape = calibrateShape.value;
        const target = shapeTargets[shape];
        if (!target) {
          calibrateHint.textContent = "";
          return;
        }
        calibrateHint.textContent = `阈值: 高宽比${target.faceRatio.toFixed(2)} / 下颌角${Math.round(target.jawAngle)}°`;
      };

      faceShapes.forEach((shape) => {
        const option = document.createElement("option");
        option.value = shape;
        option.textContent = shape;
        calibrateShape.appendChild(option);
      });
      updateCalibrateHint();
      calibrateShape.addEventListener("change", updateCalibrateHint);
      
      calibrateButton.addEventListener("click", () => {
        if (!lastMetrics) {
          alert("请先上传并完成一次分析");
          return;
        }
        const shape = calibrateShape.value;
        shapeTargets[shape] = { ...lastMetrics };
        localStorage.setItem(storageKey, JSON.stringify(shapeTargets));
        updateCalibrateHint();
        alert(`已按当前数据校准为 ${shape}`);
      });

      const renderSuggestions = (shape, detailText) => {
        faceTags.innerHTML = "";
        hairList.innerHTML = "";
        styleList.innerHTML = "";
        analysisText.textContent = detailText || "";
        adviceTitle.textContent = `专属形象建议（${displayNames[shape] || shape}）`;
        
        const tag = document.createElement("div");
        tag.className = "face-tag";
        tag.textContent = `你的脸型：${displayNames[shape] || shape}`;
        faceTags.appendChild(tag);
        
        // Add personalized text based on height/weight if available
        const height = parseFloat(heightInput.value);
        const weight = parseFloat(weightInput.value);
        
        if (height && weight) {
            const bmi = weight / ((height/100) * (height/100));
            let bodyType = "";
            if (bmi < 18.5) bodyType = "偏瘦";
            else if (bmi < 24) bodyType = "标准";
            else bodyType = "偏壮/微胖";
            
            const li = document.createElement("li");
            li.innerHTML = `<strong>体型分析 (${bodyType})</strong>: 身高 ${height}cm，搭配建议已优化比例。`;
            styleList.appendChild(li);
        }
        
        suggestions[shape].hair.forEach((item) => {
          const li = document.createElement("li");
          li.innerHTML = item;
          hairList.appendChild(li);
        });
        suggestions[shape].style.forEach((item) => {
          const li = document.createElement("li");
          li.innerHTML = item;
          styleList.appendChild(li);
        });
      };

      const createDetectionSource = (img) => {
        const targetWidth = 480;
        const ratio = img.naturalWidth / img.naturalHeight || 1;
        const width = targetWidth;
        const height = Math.round(targetWidth / ratio);
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        return canvas;
      };

      const handleFile = (file) =>
        new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            previewBox.innerHTML = "";
            const img = document.createElement("img");
            img.src = event.target.result;
            previewBox.appendChild(img);
            img.onload = () => resolve({ img, source: createDetectionSource(img) });
          };
          reader.readAsDataURL(file);
        });

      const loadModels = () => {
        if (modelsPromise) {
          return modelsPromise;
        }
        modelsPromise = (async () => {
          if (location.protocol === "file:") {
            throw new Error("请使用本地服务器打开页面");
          }
          const api = window.faceapi;
          if (!api) {
            throw new Error("未找到本地模型脚本 face-api.min.js");
          }
          const baseUrl = "./models";
          await Promise.all([
            api.nets.tinyFaceDetector.loadFromUri(baseUrl),
            api.nets.faceLandmark68TinyNet.loadFromUri(baseUrl),
          ]);
          return api;
        })();
        return modelsPromise;
      };

      const distance = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);

      const formatLoadError = (error) => {
        const message = error && error.message ? error.message : "";
        if (!message) return "模型加载失败";
        const lower = message.toLowerCase();
        if (lower.includes("failed to fetch") || lower.includes("networkerror")) {
          return "模型文件无法访问，请使用本地服务器";
        }
        return message;
      };

      const inferFaceShape = (detection) => {
        const landmarks = detection.landmarks;
        const jaw = landmarks.getJawOutline();
        const leftEye = landmarks.getLeftEye();
        const rightEye = landmarks.getRightEye();
        const box = detection.detection.box;
        const faceRatio = box.height / box.width;
        const jawWidth = distance(jaw[4], jaw[12]);
        const cheekWidth = distance(jaw[2], jaw[14]);
        const foreheadWidth = distance(leftEye[0], rightEye[3]);
        const jawToCheek = jawWidth / cheekWidth;
        const foreheadToJaw = foreheadWidth / jawWidth;
        const chin = jaw[8];
        const leftJaw = jaw[0];
        const rightJaw = jaw[16];
        const jawAngle =
          (Math.acos(
            ((leftJaw.x - chin.x) * (rightJaw.x - chin.x) +
              (leftJaw.y - chin.y) * (rightJaw.y - chin.y)) /
              (distance(leftJaw, chin) * distance(rightJaw, chin))
          ) *
            180) /
          Math.PI;

        const clamp = (value, min, max) => Math.max(min, Math.min(max, value));
        const scoreNear = (value, target, tolerance) =>
          clamp(1 - Math.abs(value - target) / tolerance, 0, 1);

        lastMetrics = { faceRatio, jawAngle, jawToCheek, foreheadToJaw };
        const scores = {
          圆脸:
            scoreNear(faceRatio, shapeTargets.圆脸.faceRatio, 0.22) * 0.5 +
            scoreNear(jawAngle, shapeTargets.圆脸.jawAngle, 22) * 0.3 +
            scoreNear(jawToCheek, shapeTargets.圆脸.jawToCheek, 0.12) * 0.2,
          方脸:
            scoreNear(faceRatio, shapeTargets.方脸.faceRatio, 0.22) * 0.35 +
            scoreNear(jawAngle, shapeTargets.方脸.jawAngle, 22) * 0.35 +
            scoreNear(jawToCheek, shapeTargets.方脸.jawToCheek, 0.12) * 0.3,
          长脸:
            scoreNear(faceRatio, shapeTargets.长脸.faceRatio, 0.28) * 0.6 +
            scoreNear(jawToCheek, shapeTargets.长脸.jawToCheek, 0.14) * 0.2 +
            scoreNear(jawAngle, shapeTargets.长脸.jawAngle, 22) * 0.2,
          心形脸:
            scoreNear(foreheadToJaw, shapeTargets.心形脸.foreheadToJaw, 0.18) * 0.55 +
            scoreNear(jawAngle, shapeTargets.心形脸.jawAngle, 22) * 0.25 +
            scoreNear(faceRatio, shapeTargets.心形脸.faceRatio, 0.22) * 0.2,
          鹅蛋脸:
            scoreNear(faceRatio, shapeTargets.鹅蛋脸.faceRatio, 0.22) * 0.4 +
            scoreNear(jawToCheek, shapeTargets.鹅蛋脸.jawToCheek, 0.12) * 0.3 +
            scoreNear(foreheadToJaw, shapeTargets.鹅蛋脸.foreheadToJaw, 0.16) * 0.2 +
            scoreNear(jawAngle, shapeTargets.鹅蛋脸.jawAngle, 18) * 0.1,
          菱形脸:
            scoreNear(faceRatio, shapeTargets.菱形脸.faceRatio, 0.22) * 0.3 +
            scoreNear(jawAngle, shapeTargets.菱形脸.jawAngle, 22) * 0.3 +
            scoreNear(jawToCheek, shapeTargets.菱形脸.jawToCheek, 0.12) * 0.25 +
            scoreNear(foreheadToJaw, shapeTargets.菱形脸.foreheadToJaw, 0.16) * 0.15,
          三角形脸:
            scoreNear(faceRatio, shapeTargets.三角形脸.faceRatio, 0.22) * 0.35 +
            scoreNear(jawAngle, shapeTargets.三角形脸.jawAngle, 22) * 0.35 +
            scoreNear(jawToCheek, shapeTargets.三角形脸.jawToCheek, 0.12) * 0.3,
        };

        const ranked = Object.entries(scores).sort((a, b) => b[1] - a[1]);
        const shape = ranked[0][0];
        const confidence = ranked[0][1];
        
        const detailText = `特征数据：脸高/宽比 ${faceRatio.toFixed(2)} · 下颌角 ${Math.round(jawAngle)}° (置信度 ${Math.round(confidence * 100)}%)`;
        return { shape, detailText };
      };

      // Drag and Drop Logic
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });
      function highlight(e) {
        dropZone.classList.add('dragover');
      }
      function unhighlight(e) {
        dropZone.classList.remove('dragover');
      }
      dropZone.addEventListener('drop', handleDrop, false);
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }
      fileInput.addEventListener("change", function() {
        handleFiles(this.files);
      });

      async function handleFiles(files) {
        const file = files[0];
        if (!file) return;
        
        loadingState.classList.remove('hidden');
        resultSection.classList.add('hidden');
        
        try {
            const { img, source } = await handleFile(file);
            const api = await loadModels();
            const detectorOptions = new api.TinyFaceDetectorOptions({
                inputSize: 320,
                scoreThreshold: 0.5,
            });
            
            const detection = await api
                .detectSingleFace(source, detectorOptions)
                .withFaceLandmarks(true);
                
            if (!detection) {
                alert("未识别到正脸，请换一张清晰正脸照");
                loadingState.classList.add('hidden');
                return;
            }
            
            const result = inferFaceShape(detection);
            renderSuggestions(result.shape || faceShapes[2], result.detailText);
            
            loadingState.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            // Force reflow for animation
            void resultSection.offsetWidth;
            
            resultSection.classList.add('visible');
            
            // Smooth scroll to result
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
        } catch (error) {
            loadingState.classList.add('hidden');
            alert(formatLoadError(error));
        }
      }
    </script>
  </body>
</html>
